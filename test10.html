<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The ONE Thing - Global</title>
    <style>
        /* --- VARIABLES --- */
        :root {
            --bg-color: #fcfbf9;
            --text-color: #2c2c2c;
            --accent-color: #2e2e2e;
            --highlight-color: #d32f2f;
            --success-color: #4caf50;
            --card-bg: #ffffff;
            --input-bg: #f0f0f0;
            --font-main: 'Georgia', 'Times New Roman', serif;
            --font-ui: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color); color: var(--text-color);
            margin: 0; padding: 0; overflow: hidden; height: 100vh; width: 100vw;
            transition: background 0.4s, color 0.4s; user-select: none;
        }

        /* --- SCROLL REEL --- */
        .reel-container { height: 100vh; width: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; scroll-behavior: smooth; scrollbar-width: none; }
        .reel-container::-webkit-scrollbar { display: none; }

        section.life-slide {
            height: 100vh; width: 100%; scroll-snap-align: start;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box; position: relative;
        }

        h1.area-title {
            font-family: var(--font-ui); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 3px;
            opacity: 0.5; margin: 0 0 40px 0; color: var(--text-color); transition: 0.5s;
        }

        /* --- INPUT & DISPLAY --- */
        .input-mode { width: 100%; max-width: 500px; display: flex; flex-direction: column; align-items: center; }
        .question { font-size: 1.3rem; line-height: 1.5; text-align: center; margin-bottom: 30px; max-width: 650px; }
        .highlight { color: var(--highlight-color); font-weight: bold; border-bottom: 2px solid rgba(211, 47, 47, 0.1); }

        input[type="text"].main-input {
            width: 80%; padding: 15px; font-family: var(--font-main); font-size: 1.2rem;
            border: none; border-bottom: 2px solid #ddd; background: transparent; color: var(--text-color);
            text-align: center; margin-bottom: 30px; outline: none;
        }
        input[type="text"].main-input:focus { border-bottom-color: var(--accent-color); }
        input[type="text"].main-input::placeholder { color: var(--text-color); opacity: 0.3; font-style: italic; font-size: 1rem; }

        .active-task-display {
            display: none; text-align: center; width: 100%; max-width: 600px;
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .big-task { font-size: 2.2rem; font-weight: bold; margin: 10px 0 10px 0; line-height: 1.2; }
        .focus-label { font-family: var(--font-ui); font-size: 0.7rem; letter-spacing: 2px; text-transform: uppercase; opacity: 0.6; display: block; margin-bottom: 10px; }

        .queue-badge {
            background: rgba(0,0,0,0.05); padding: 5px 15px; border-radius: 15px;
            font-family: var(--font-ui); font-size: 0.8rem; color: var(--text-color); opacity: 0.7;
            margin-bottom: 20px; display: inline-block;
        }

        /* --- BUTTONS --- */
        button.action-btn {
            background-color: var(--accent-color); color: var(--bg-color); border: none; padding: 15px 40px;
            font-family: var(--font-ui); font-weight: 600; font-size: 1rem; border-radius: 50px; cursor: pointer;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); transition: transform 0.2s;
        }
        button.action-btn:active { transform: scale(0.95); }

        .floating-menu { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 15px; z-index: 100; }
        .float-btn {
            width: 50px; height: 50px; border-radius: 50%; background: var(--bg-color);
            border: 1px solid rgba(0,0,0,0.1); color: var(--text-color); box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
        }

        /* --- OVERLAYS --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); color: var(--text-color); z-index: 200;
            display: none; padding: 20px; box-sizing: border-box; overflow-y: auto; backdrop-filter: blur(10px);
        }
        .overlay.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
        .close-btn { position: absolute; top: 20px; right: 20px; font-size: 2rem; cursor: pointer; background:none; border:none; color: var(--text-color); z-index:10; }
        .overlay-header { text-align: center; font-family: var(--font-main); margin-bottom: 30px; font-size: 1.5rem; font-weight: bold; }

        /* --- UI ELEMENTS --- */
        .styled-input, .time-input-styled { width: 100%; padding: 15px; margin-bottom: 20px; border: none; border-radius: 20px; background: #fff; color: #333; font-family: var(--font-ui); font-size: 1rem; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); outline: none; box-sizing: border-box;}
        .time-input-styled { font-weight: bold; font-size: 1.2rem; cursor: pointer; }
        
        .area-icon-row { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .area-option { display: flex; flex-direction: column; align-items: center; cursor: pointer; width: 60px; }
        .area-icon-btn { width: 45px; height: 45px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 2px solid transparent; }
        .area-label { font-family: var(--font-ui); font-size: 0.6rem; text-transform: uppercase; color: #888; font-weight: bold; margin-top: 5px; }
        .area-option.selected .area-icon-btn { background: var(--accent-color); color: white; transform: scale(1.1); }
        .area-option.selected .area-label { color: var(--text-color); }

        .palette-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; justify-items: center; }
        .color-swatch { width: 35px; height: 35px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(0,0,0,0.1); }
        
        .routine-card, .sortable-item { padding: 15px; background: rgba(0,0,0,0.03); margin-bottom: 10px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; font-family: var(--font-ui); }
        .routine-card { background: var(--card-bg); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        /* --- LANGUAGE SWITCHER STYLE --- */
        .lang-switch-row { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; }
        .lang-btn { 
            padding: 10px 20px; border-radius: 20px; border: 1px solid rgba(0,0,0,0.1); 
            background: transparent; cursor: pointer; font-family: var(--font-ui); font-weight: bold; color: var(--text-color);
        }
        .lang-btn.active { background: var(--accent-color); color: var(--bg-color); border-color: var(--accent-color); }

    </style>
</head>
<body>

<div class="floating-menu">
    <button class="float-btn" onclick="openOverlay('routineOverlay')">‚è∞</button>
    <button class="float-btn" onclick="openOverlay('historyOverlay')">üèÜ</button>
    <button class="float-btn" onclick="openOverlay('settingsOverlay')">‚öôÔ∏è</button>
</div>

<main class="reel-container" id="mainContainer"></main>

<div id="routineOverlay" class="overlay">
    <button class="close-btn" onclick="closeOverlay('routineOverlay')">√ó</button>
    <div class="overlay-header" data-i18n="new_routine">Neue Routine</div>
    
    <div style="background: rgba(0,0,0,0.03); padding: 25px; border-radius: 30px; margin-bottom: 30px; text-align: center;">
        <span style="display:block; font-family:var(--font-ui); font-size:0.8rem; margin-bottom:10px; opacity:0.6;" data-i18n="select_area">Bereich W√§hlen</span>
        
        <div class="area-icon-row" id="routineAreaSelector">
            </div>
        <input type="hidden" id="rout-area" value="business">

        <input type="text" id="rout-input" class="styled-input">
        
        <span style="display:block; font-family:var(--font-ui); font-size:0.8rem; margin-bottom:5px; opacity:0.6;" data-i18n="time">Uhrzeit</span>
        <input type="time" id="rout-time" class="time-input-styled" value="08:00">

        <button class="action-btn" style="width:100%;" onclick="addRoutine()" data-i18n="add">Hinzuf√ºgen</button>
    </div>
    <div id="routineList" style="padding-bottom: 50px;"></div>
</div>

<div id="settingsOverlay" class="overlay">
    <button class="close-btn" onclick="closeOverlay('settingsOverlay')">√ó</button>
    <div class="overlay-header" data-i18n="settings">Einstellungen</div>

    <div class="lang-switch-row">
        <button class="lang-btn" onclick="setLanguage('de')" id="lang-de">DE</button>
        <button class="lang-btn" onclick="setLanguage('en')" id="lang-en">EN</button>
        <button class="lang-btn" onclick="setLanguage('es')" id="lang-es">ES</button>
    </div>

    <div style="background: rgba(0,0,0,0.03); padding: 20px; border-radius: 20px; margin-bottom: 20px;">
        <span style="display:block;margin-bottom:10px;" data-i18n="bg_color">üé® Hintergrund</span>
        <div class="palette-grid" id="bg-palette"></div>
        <span style="display:block;margin:20px 0 10px 0;" data-i18n="accent_color">üé® Akzent</span>
        <div class="palette-grid" id="accent-palette"></div>
    </div>
    <div style="background: rgba(0,0,0,0.03); padding: 20px; border-radius: 20px;">
        <span style="display:block;margin-bottom:10px;" data-i18n="order">üîÉ Reihenfolge</span>
        <ul id="dragList" style="list-style:none; padding:0;"></ul>
    </div>
</div>

<div id="historyOverlay" class="overlay">
    <button class="close-btn" onclick="closeOverlay('historyOverlay')">√ó</button>
    <div class="overlay-header" data-i18n="successes">Erfolge</div>
    <ul id="historyList" style="list-style:none; padding:0;"></ul>
    <div style="text-align:center; margin-top:20px;">
        <button onclick="clearHistory()" style="background:none; border:none; color:red;" data-i18n="clear_history">Verlauf l√∂schen</button>
    </div>
</div>

<script>
    // --- TRANSLATION DATABASE (The ONE Thing Phrasings) ---
    const i18n = {
        de: {
            focus_btn: "Fokus setzen",
            done_btn: "Erledigt",
            waiting: "wartet im Hintergrund",
            settings: "Einstellungen",
            new_routine: "Neue Routine",
            select_area: "Bereich w√§hlen",
            time: "Uhrzeit",
            add: "Hinzuf√ºgen",
            bg_color: "üé® Hintergrund",
            accent_color: "üé® Akzent",
            order: "üîÉ Reihenfolge",
            successes: "Erfolge",
            clear_history: "Verlauf l√∂schen",
            alert_input: "Bitte Text und Zeit eingeben.",
            alert_next: "Erledigt! N√§chste Aufgabe:",
            routine_notify: "Routine Zeit",
            routine_placeholder: "z.B. Team-Meeting vorbereiten",
            areas: {
                business: { title: "Business & Beruf", label: "Business", placeholder: "z.B. Projektplan finalisieren", 
                            question: "Welche ist die <span class='highlight'>EINE Sache</span> f√ºr meinen <b>Beruf</b>, die alle anderen Aufgaben einfacher oder √ºberfl√ºssig macht?" },
                finance: { title: "Finanzen", label: "Finanzen", placeholder: "z.B. Sparrate auf 20% erh√∂hen", 
                           question: "Welche ist die <span class='highlight'>EINE Sache</span> f√ºr meine <b>Finanzen</b>, die alle anderen Aufgaben einfacher oder √ºberfl√ºssig macht?" },
                health: { title: "K√∂rper & Gesundheit", label: "K√∂rper", placeholder: "z.B. 30 Minuten Joggen gehen", 
                          question: "Welche ist die <span class='highlight'>EINE Sache</span> f√ºr meine <b>Gesundheit</b>, die alle anderen Aufgaben einfacher oder √ºberfl√ºssig macht?" },
                personal: { title: "Privat & Familie", label: "Privat", placeholder: "z.B. Date-Night mit Partner:in planen", // Gendern mit :
                            question: "Welche ist die <span class='highlight'>EINE Sache</span> f√ºr mein <b>Privatleben</b>, die alle anderen Aufgaben einfacher oder √ºberfl√ºssig macht?" },
                spiritual: { title: "Geist & Spirituelles", label: "Geist", placeholder: "z.B. 10 Minuten Meditation", 
                             question: "Welche ist die <span class='highlight'>EINE Sache</span> f√ºr meinen <b>inneren Frieden</b>, die alle anderen Aufgaben einfacher oder √ºberfl√ºssig macht?" }
            }
        },
        en: {
            focus_btn: "Set Focus",
            done_btn: "Done",
            waiting: "waiting in queue",
            settings: "Settings",
            new_routine: "New Routine",
            select_area: "Select Area",
            time: "Time",
            add: "Add",
            bg_color: "üé® Background",
            accent_color: "üé® Accent",
            order: "üîÉ Order",
            successes: "Successes",
            clear_history: "Clear History",
            alert_input: "Please enter text and time.",
            alert_next: "Done! Next task:",
            routine_notify: "Routine Time",
            routine_placeholder: "e.g. Prepare team meeting",
            areas: {
                business: { title: "Business & Career", label: "Business", placeholder: "e.g. Finalize project plan", 
                            question: "What's the <span class='highlight'>ONE Thing</span> I can do for my <b>career</b> such that by doing it everything else will be easier or unnecessary?" },
                finance: { title: "Finance", label: "Finance", placeholder: "e.g. Increase savings rate", 
                           question: "What's the <span class='highlight'>ONE Thing</span> I can do for my <b>finances</b> such that by doing it everything else will be easier or unnecessary?" },
                health: { title: "Physical Health", label: "Health", placeholder: "e.g. Go for a 30 min run", 
                          question: "What's the <span class='highlight'>ONE Thing</span> I can do for my <b>physical health</b> such that by doing it everything else will be easier or unnecessary?" },
                personal: { title: "Personal Life", label: "Personal", placeholder: "e.g. Plan date night with partner", 
                            question: "What's the <span class='highlight'>ONE Thing</span> I can do for my <b>personal life</b> such that by doing it everything else will be easier or unnecessary?" },
                spiritual: { title: "Spiritual", label: "Spirit", placeholder: "e.g. 10 minutes meditation", 
                             question: "What's the <span class='highlight'>ONE Thing</span> I can do for my <b>spiritual life</b> such that by doing it everything else will be easier or unnecessary?" }
            }
        },
        es: {
            focus_btn: "Enfocar",
            done_btn: "Hecho",
            waiting: "en cola",
            settings: "Ajustes",
            new_routine: "Nueva Rutina",
            select_area: "Seleccionar √Årea",
            time: "Hora",
            add: "A√±adir",
            bg_color: "üé® Fondo",
            accent_color: "üé® Acento",
            order: "üîÉ Orden",
            successes: "√âxitos",
            clear_history: "Borrar Historial",
            alert_input: "Por favor ingrese texto y hora.",
            alert_next: "¬°Hecho! Siguiente tarea:",
            routine_notify: "Hora de Rutina",
            routine_placeholder: "p.ej. Preparar reuni√≥n",
            areas: {
                business: { title: "Negocios y Carrera", label: "Negocio", placeholder: "p.ej. Finalizar plan", 
                            question: "¬øCu√°l es la <span class='highlight'>√öNICA cosa</span> que puedo hacer por mi <b>carrera</b> de tal modo que al hacerlo todo lo dem√°s sea m√°s f√°cil o innecesario?" },
                finance: { title: "Finanzas", label: "Finanzas", placeholder: "p.ej. Aumentar ahorro", 
                           question: "¬øCu√°l es la <span class='highlight'>√öNICA cosa</span> que puedo hacer por mis <b>finanzas</b> de tal modo que al hacerlo todo lo dem√°s sea m√°s f√°cil o innecesario?" },
                health: { title: "Salud F√≠sica", label: "Salud", placeholder: "p.ej. Correr 30 min", 
                          question: "¬øCu√°l es la <span class='highlight'>√öNICA cosa</span> que puedo hacer por mi <b>salud</b> de tal modo que al hacerlo todo lo dem√°s sea m√°s f√°cil o innecesario?" },
                personal: { title: "Vida Personal", label: "Personal", placeholder: "p.ej. Cita con mi pareja", 
                            question: "¬øCu√°l es la <span class='highlight'>√öNICA cosa</span> que puedo hacer por mi <b>vida personal</b> de tal modo que al hacerlo todo lo dem√°s sea m√°s f√°cil o innecesario?" },
                spiritual: { title: "Espiritualidad", label: "Esp√≠ritu", placeholder: "p.ej. Meditar 10 min", 
                             question: "¬øCu√°l es la <span class='highlight'>√öNICA cosa</span> que puedo hacer por mi <b>vida espiritual</b> de tal modo que al hacerlo todo lo dem√°s sea m√°s f√°cil o innecesario?" }
            }
        }
    };

    // --- STATE ---
    const defaultOrder = ['business', 'finance', 'health', 'personal', 'spiritual'];
    const defaultTheme = { bg: '#fcfbf9', text: '#2c2c2c', accent: '#2e2e2e' };
    
    let appData = {
        lang: 'de', // Default, will be overwritten by auto-detect
        tasks: { business: "", health: "", personal: "", finance: "", spiritual: "" },
        backlog: { business: [], health: [], personal: [], finance: [], spiritual: [] },
        history: [],
        routines: [],
        order: [...defaultOrder],
        theme: {...defaultTheme}
    };

    try {
        const saved = localStorage.getItem('theOneThingData_v10');
        if (saved) {
            const parsed = JSON.parse(saved);
            appData = { ...appData, ...parsed };
            if(!appData.backlog) appData.backlog = { business: [], health: [], personal: [], finance: [], spiritual: [] };
            if(!appData.lang) appData.lang = detectLanguage(); // Fallback for old users
        } else {
            appData.lang = detectLanguage(); // New users
        }
    } catch (e) {}

    // --- HELPERS ---
    function detectLanguage() {
        const browser = navigator.language || navigator.userLanguage;
        if (browser.startsWith('de')) return 'de';
        if (browser.startsWith('es')) return 'es';
        return 'en';
    }

    const colors = {
        bg: ['#fcfbf9', '#ffffff', '#f0f4f8', '#fff3e0', '#f3e5f5', '#1a1a1a', '#212121', '#000000'],
        accent: ['#2e2e2e', '#d32f2f', '#c2185b', '#7b1fa2', '#1976d2', '#388e3c', '#f57c00']
    };

    function initApp() {
        applyThemeStyles();
        updateLanguageUI(); // Update texts
        renderSlides();
        renderPalettes();
        renderDragList();
        renderRoutineAreaSelector();
        appData.order.forEach(a => updateSlideUI(a));
        if(Notification.permission !== "granted") Notification.requestPermission();
    }

    // --- LANGUAGE LOGIC ---
    function setLanguage(lang) {
        appData.lang = lang;
        saveData();
        updateLanguageUI();
        renderSlides(); // Re-render questions
        renderDragList(); // Re-render drag names
        renderRoutineAreaSelector();
        renderRoutinen(); // Update routine labels
        renderHistory(); // Update history labels
        appData.order.forEach(a => updateSlideUI(a));
    }

    function updateLanguageUI() {
        // Buttons active state
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('lang-'+appData.lang).classList.add('active');

        // Static texts
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if(i18n[appData.lang][key]) el.innerText = i18n[appData.lang][key];
        });
        
        // Placeholder Routine Input
        document.getElementById('rout-input').placeholder = i18n[appData.lang].routine_placeholder;
    }

    // --- RENDER SLIDES ---
    function renderSlides() {
        const container = document.getElementById('mainContainer');
        container.innerHTML = "";
        const t = i18n[appData.lang];

        appData.order.forEach(area => {
            const config = t.areas[area];
            const section = document.createElement('section');
            section.className = "life-slide";
            section.id = `slide-${area}`;
            
            section.innerHTML = `
                <h1 class="area-title">${config.title}</h1>
                <div class="input-mode" id="input-${area}">
                    <p class="question">${config.question}</p>
                    <input type="text" class="main-input" id="in-${area}" placeholder="${config.placeholder}">
                    <button class="action-btn" onclick="setOneThing('${area}')">${t.focus_btn}</button>
                </div>
                <div class="active-task-display" id="display-${area}">
                    <span class="focus-label">FOKUS ‚Ä¢ ${config.title.toUpperCase()}</span>
                    <div class="big-task" id="text-${area}"></div>
                    <div class="queue-badge" id="queue-${area}" style="display:none;">
                        +<span id="count-${area}">0</span> ${t.waiting}
                    </div>
                    <br>
                    <button class="action-btn" style="background-color: var(--success-color);" onclick="completeTask('${area}')">${t.done_btn}</button>
                </div>
            `;
            container.appendChild(section);
        });
    }

    function renderRoutineAreaSelector() {
        const container = document.getElementById('routineAreaSelector');
        container.innerHTML = "";
        const icons = { business: "üíº", finance: "üí∞", health: "‚ù§Ô∏è", personal: "üè†", spiritual: "üßò" };
        const areas = ['business', 'finance', 'health', 'personal', 'spiritual'];
        
        areas.forEach(area => {
            const label = i18n[appData.lang].areas[area].label;
            const isSelected = document.getElementById('rout-area').value === area ? 'selected' : '';
            container.innerHTML += `
            <div class="area-option ${isSelected}" onclick="selectRoutineArea(this, '${area}')">
                <div class="area-icon-btn">${icons[area]}</div>
                <span class="area-label">${label}</span>
            </div>`;
        });
    }

    // --- LOGIC ---
    function setOneThing(area, textOverride = null) {
        const input = document.getElementById(`in-${area}`);
        const text = textOverride || input.value;
        if(!text) return;
        if (appData.tasks[area] && appData.tasks[area] !== "") {
            appData.backlog[area].push(appData.tasks[area]);
        }
        appData.tasks[area] = text;
        input.value = "";
        saveData();
        updateSlideUI(area);
    }

    function completeTask(area) {
        const currentTask = appData.tasks[area];
        if (currentTask) {
            appData.history.unshift({ task: currentTask, area: area, date: new Date().toLocaleDateString(appData.lang) });
            if (appData.backlog[area].length > 0) {
                const nextTask = appData.backlog[area].shift();
                appData.tasks[area] = nextTask;
                alert(`${i18n[appData.lang].alert_next} "${nextTask}"`);
            } else {
                appData.tasks[area] = "";
            }
            saveData();
            updateSlideUI(area);
        }
    }

    function updateSlideUI(area) {
        const hasTask = appData.tasks[area] && appData.tasks[area] !== "";
        const inp = document.getElementById(`input-${area}`);
        const disp = document.getElementById(`display-${area}`);
        if(inp) inp.style.display = hasTask ? 'none' : 'flex';
        if(disp) disp.style.display = hasTask ? 'block' : 'none';
        
        if (hasTask) {
            document.getElementById(`text-${area}`).innerText = appData.tasks[area];
            const queueCount = appData.backlog[area].length;
            const badge = document.getElementById(`queue-${area}`);
            if (queueCount > 0) {
                badge.style.display = "inline-block";
                document.getElementById(`count-${area}`).innerText = queueCount;
            } else {
                badge.style.display = "none";
            }
        }
    }

    function addRoutine() {
        const text = document.getElementById('rout-input').value;
        const area = document.getElementById('rout-area').value;
        const time = document.getElementById('rout-time').value;
        if (!text || !time) return alert(i18n[appData.lang].alert_input);
        appData.routines.push({ id: Date.now(), text, area, time, lastTriggered: "" });
        saveData(); renderRoutinen();
        document.getElementById('rout-input').value = "";
    }
    
    function renderRoutinen() {
        const list = document.getElementById('routineList'); list.innerHTML = "";
        appData.routines.sort((a,b)=>a.time.localeCompare(b.time)).forEach(r => {
            const areaLabel = i18n[appData.lang].areas[r.area].title;
            list.innerHTML += `<div class="routine-card">
                <div style="font-weight:bold; color:var(--highlight-color); margin-right:15px;">${r.time}</div>
                <div style="flex-grow:1;"><small>${areaLabel}</small><br>${r.text}</div>
                <button onclick="deleteRoutine(${r.id})" style="border:none;background:none;color:red;">√ó</button>
            </div>`;
        });
    }
    function deleteRoutine(id) { appData.routines = appData.routines.filter(r => r.id !== id); saveData(); renderRoutinen(); }

    setInterval(() => {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        const dateStr = now.toDateString();
        appData.routines.forEach(r => {
            if (r.time === timeStr && r.lastTriggered !== dateStr) {
                setOneThing(r.area, r.text);
                r.lastTriggered = dateStr;
                saveData();
                document.getElementById(`slide-${r.area}`).scrollIntoView({ behavior: 'smooth' });
                if (Notification.permission === "granted") new Notification(i18n[appData.lang].routine_notify, { body: r.text });
            }
        });
    }, 1000);

    function selectRoutineArea(div, area) {
        document.querySelectorAll('.area-option').forEach(b => b.classList.remove('selected'));
        div.classList.add('selected');
        document.getElementById('rout-area').value = area;
    }
    function saveData() { localStorage.setItem('theOneThingData_v10', JSON.stringify(appData)); }
    function openOverlay(id) { document.getElementById(id).classList.add('active'); if(id==='historyOverlay')renderHistory(); if(id==='routineOverlay')renderRoutinen(); }
    function closeOverlay(id) { document.getElementById(id).classList.remove('active'); }
    
    function renderPalettes() {
        const bg = document.getElementById('bg-palette'); bg.innerHTML = "";
        colors.bg.forEach(c => bg.innerHTML += `<div class="color-swatch" style="background:${c}" onclick="setTheme('bg','${c}')"></div>`);
        const acc = document.getElementById('accent-palette'); acc.innerHTML = "";
        colors.accent.forEach(c => acc.innerHTML += `<div class="color-swatch" style="background:${c}" onclick="setTheme('accent','${c}')"></div>`);
    }
    function setTheme(type, c) {
        if(type==='bg') { appData.theme.bg = c; appData.theme.text = (parseInt(c.replace('#',''),16)<0xffffff/2) ? '#fff':'#2c2c2c'; }
        else appData.theme.accent = c;
        applyThemeStyles(); saveData();
    }
    function applyThemeStyles() {
        const r = document.documentElement.style;
        r.setProperty('--bg-color', appData.theme.bg);
        r.setProperty('--text-color', appData.theme.text);
        r.setProperty('--accent-color', appData.theme.accent);
    }
    
    function renderDragList() {
        const list = document.getElementById('dragList'); list.innerHTML = "";
        appData.order.forEach((area, i) => {
            const li = document.createElement('li');
            li.className = 'sortable-item'; li.innerHTML = `${i18n[appData.lang].areas[area].title} <span>‚ò∞</span>`;
            li.draggable = true;
            li.ondragstart = e => { e.dataTransfer.setData('idx', i); };
            li.ondragover = e => e.preventDefault();
            li.ondrop = e => {
                const oldIdx = e.dataTransfer.getData('idx');
                const val = appData.order.splice(oldIdx, 1)[0];
                appData.order.splice(i, 0, val);
                saveData(); renderDragList(); renderSlides(); appData.order.forEach(a => updateSlideUI(a));
            };
            li.ontouchstart = e => { li.dataset.touchIdx = i; };
            li.ontouchmove = e => e.preventDefault(); 
            li.ontouchend = e => { 
                const val = appData.order.splice(i, 1)[0];
                appData.order.push(val);
                saveData(); renderDragList(); renderSlides(); appData.order.forEach(a => updateSlideUI(a));
            };
            list.appendChild(li);
        });
    }

    function renderHistory() {
        const l = document.getElementById('historyList'); l.innerHTML = "";
        appData.history.forEach(h => l.innerHTML += `<li style="padding:15px; border-bottom:1px solid rgba(0,0,0,0.1);"><small>${h.date} ‚Ä¢ ${i18n[appData.lang].areas[h.area].title}</small><br>${h.task}</li>`);
    }
    function clearHistory() { appData.history=[]; saveData(); renderHistory(); }

    initApp();
</script>
</body>
</html>