<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#fdfbf7">
    <title>The ONE Thing</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

    <style>
        :root {
            /* NOBLE THEME DEFAULT */
            --bg-color: #fdfbf7;
            --text-main: #1a1a1a;
            --text-sub: #555555;
            --accent-color: #1e272e;
            --accent-gold: #d4af37;
            --success-color: #27ae60;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --card-bg: #ffffff;
            --font-headline: 'Playfair Display', serif;
            --font-body: 'Inter', sans-serif;
            --bg-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
        }

        * { -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-color); color: var(--text-main);
            margin: 0; padding: 0; overflow: hidden; height: 100dvh; width: 100vw;
            user-select: none; background-image: var(--bg-image);
            transition: background-color 0.5s ease;
        }

        /* --- ICONS --- */
        .icon { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .icon-xl { width: 60px; height: 60px; stroke-width: 1.2; color: var(--accent-gold); margin-bottom: 20px; filter: drop-shadow(0 10px 10px rgba(212, 175, 55, 0.2)); }

        /* --- LAYOUT (INSTA STYLE) --- */
        .reel-container { 
            height: 100dvh; width: 100%; 
            overflow-y: scroll; 
            scroll-snap-type: y mandatory; 
            scroll-behavior: smooth; 
            scrollbar-width: none; 
        }
        .reel-container::-webkit-scrollbar { display: none; }

        section.life-slide { 
            height: 100dvh; width: 100%; 
            scroll-snap-align: start; 
            scroll-snap-stop: always; /* Zwingt zum Anhalten */
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            padding: 20px; box-sizing: border-box; 
            position: relative;
        }

        /* --- COMPACT TYPOGRAPHY --- */
        h1.area-title { 
            font-family: var(--font-body); font-size: 0.65rem; text-transform: uppercase; letter-spacing: 4px; font-weight: 700; 
            color: var(--accent-gold); margin: 0 0 30px 0; opacity: 0.9;
            position: absolute; top: 40px; /* Fix oben */
        }

        .content-wrapper {
            width: 100%; max-width: 360px; /* iPhone width friendly */
            padding-right: 50px; /* Platz f√ºr Men√º rechts */
            display: flex; flex-direction: column; align-items: center;
            box-sizing: border-box;
        }

        .input-mode { width: 100%; display: flex; flex-direction: column; align-items: center; }
        
        .question { 
            font-family: var(--font-headline); font-size: 1.4rem; line-height: 1.3; 
            text-align: center; margin-bottom: 30px; color: var(--text-main); 
        }
        .highlight { color: var(--accent-color); font-weight: 700; border-bottom: 2px solid var(--accent-gold); }

        input[type="text"].main-input { 
            width: 90%; padding: 15px; font-family: var(--font-headline); font-size: 1.2rem; 
            border: 1px solid rgba(0,0,0,0.08); border-radius: 15px; 
            background: var(--card-bg); color: var(--text-main); text-align: center; 
            margin-bottom: 25px; outline: none; 
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.05); transition: all 0.3s ease; 
        }
        input[type="text"].main-input:focus { transform: scale(1.02); border-color: var(--accent-gold); box-shadow: 0 15px 30px -5px rgba(212, 175, 55, 0.15); }
        
        .active-task-display { display: none; text-align: center; width: 100%; animation: fadeInScale 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes fadeInScale { from { transform: scale(0.95); opacity: 0; filter: blur(5px); } to { transform: scale(1); opacity: 1; filter: blur(0); } }

        .big-task { font-family: var(--font-headline); font-size: 2rem; font-weight: 700; margin: 10px 0 20px 0; line-height: 1.1; letter-spacing: -0.5px; word-wrap: break-word;}
        .focus-label { font-family: var(--font-body); font-size: 0.6rem; letter-spacing: 3px; text-transform: uppercase; color: var(--text-sub); display: block; margin-bottom: 8px; }
        
        .queue-badge { 
            background: var(--card-bg); padding: 5px 12px; border-radius: 20px; 
            font-family: var(--font-body); font-size: 0.7rem; color: var(--text-sub); 
            margin-bottom: 25px; display: inline-block; box-shadow: 0 4px 8px rgba(0,0,0,0.03); 
        }

        button.action-btn { 
            background-color: var(--accent-color); color: var(--bg-color); border: none; padding: 14px 35px; 
            font-family: var(--font-body); font-weight: 600; font-size: 0.85rem; letter-spacing: 1px; text-transform: uppercase; 
            border-radius: 99px; cursor: pointer; box-shadow: 0 10px 20px -5px rgba(0,0,0,0.15); 
            transition: all 0.2s; position: relative; overflow: hidden; 
        }
        button.action-btn:active { transform: scale(0.96); }
        
        /* --- FLOATING MENU (COMPACT) --- */
        .floating-menu { 
            position: fixed; bottom: 25px; right: 15px; 
            display: flex; flex-direction: column; gap: 15px; z-index: 100; 
        }
        .float-btn { 
            width: 45px; height: 45px; border-radius: 50%; background: var(--card-bg); 
            border: none; color: var(--text-main); 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer; 
            display: flex; align-items: center; justify-content: center; transition: transform 0.2s; 
        }
        .float-btn:hover { transform: scale(1.05); }
        .float-btn svg { width: 18px; height: 18px; }

        /* --- INTRO STYLES --- */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100dvh;
            background: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease; overflow: hidden;
        }
        
        .intro-slide {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 30px; box-sizing: border-box;
            transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.6s ease;
            will-change: transform; 
        }
        .intro-slide.active { opacity: 1 !important; pointer-events: auto; transform: translateY(0) scale(1); z-index: 2; }
        .intro-slide.prev { opacity: 0 !important; transform: translateY(-100%) scale(0.95); z-index: 1; pointer-events: none; }
        .intro-slide.next { opacity: 0 !important; transform: translateY(100%) scale(0.95); z-index: 1; pointer-events: none; }
        
        .intro-quote { font-family: var(--font-headline); font-size: 1.6rem; font-weight: 700; color: var(--text-main); margin-bottom: 20px; line-height: 1.2; }
        .intro-sub { font-family: var(--font-body); font-size: 0.75rem; letter-spacing: 2px; text-transform: uppercase; color: var(--accent-gold); margin-bottom: 30px; }
        .intro-title { font-family: var(--font-headline); font-size: 2rem; font-weight: 700; color: var(--text-main); margin-bottom: 10px; }
        .intro-text { font-family: var(--font-headline); font-size: 1.1rem; color: var(--text-sub); line-height: 1.5; margin-bottom: 40px; max-width: 300px;}

        /* Swipe Hint */
        #global-swipe-hint {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            opacity: 0; pointer-events: none; transition: opacity 0.5s; z-index: 5;
        }
        #global-swipe-hint.visible { opacity: 1; animation: fadeUp 2s infinite; }
        .swipe-text { font-family: var(--font-body); font-size: 0.6rem; text-transform: uppercase; letter-spacing: 2px; opacity: 0.5; color: var(--accent-color); }
        .swipe-arrow { width: 24px; height: 24px; color: var(--accent-gold); }
        @keyframes fadeUp { 0% { transform: translate(-50%, 10px); opacity: 0; } 50% { transform: translate(-50%, 0px); opacity: 1; } 100% { transform: translate(-50%, -10px); opacity: 0; } }

        .intro-dots { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 10px; }
        .dot { width: 5px; height: 5px; border-radius: 50%; background: rgba(0,0,0,0.1); transition: 0.4s; }
        .dot.active { background: var(--accent-gold); transform: scale(1.8); }

        /* --- OVERLAYS --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; background: var(--bg-color); z-index: 200; display: none; padding: 25px; box-sizing: border-box; overflow-y: auto; }
        .overlay.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
        .close-btn { position: absolute; top: 20px; right: 20px; font-size: 2rem; cursor: pointer; background:none; border:none; color: var(--text-main); z-index:10; }
        .overlay-header { text-align: center; font-family: var(--font-headline); margin-bottom: 30px; font-size: 1.6rem; font-weight: 700; margin-top: 10px;}
        .overlay-card { background: var(--card-bg); padding: 25px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); }
        
        /* Drag List */
        .sortable-list { list-style: none; padding: 0; margin: 0; }
        .sortable-item { padding: 15px 20px; background: var(--card-bg); margin-bottom: 10px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; font-family: var(--font-body); font-weight: 600; font-size: 0.9rem; box-shadow: 0 5px 10px rgba(0,0,0,0.03); cursor: grab; user-select: none; touch-action: none; transition: 0.2s; }
        .sortable-item span { opacity: 0.3; font-size: 1.2rem; }
        .sortable-item.dragging { opacity: 0.9; background: var(--accent-gold); color: #fff; transform: scale(1.05); z-index: 1000; }
        .sortable-item.dragging span { color: #fff; opacity: 1; }

        /* Themes */
        .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .theme-btn { padding: 15px; border-radius: 12px; border: 2px solid transparent; background: #f0f0f0; cursor: pointer; text-align: center; transition: 0.2s; font-family: var(--font-body); font-weight: 600; font-size: 0.8rem; }
        .theme-btn.active { border-color: var(--accent-gold); background: rgba(212, 175, 55, 0.1); color: var(--accent-gold); }
        .theme-preview { width: 25px; height: 25px; border-radius: 50%; margin: 0 auto 8px auto; border: 1px solid rgba(0,0,0,0.1); }

        /* Toast */
        #notification-container { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); z-index: 1000; width: 90%; max-width: 320px; pointer-events: none; }
        .toast { background: var(--accent-color); color: var(--bg-color); padding: 15px 20px; border-radius: 99px; margin-bottom: 10px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 15px; animation: slideDown 0.5s cubic-bezier(0.19, 1, 0.22, 1); pointer-events: auto; }
        .toast-icon { color: var(--accent-gold); display:flex; align-items:center; }
        .toast-content { flex-grow: 1; text-align: left; }
        .toast-title { font-family: var(--font-body); font-weight: 700; font-size: 0.65rem; color: var(--accent-gold); text-transform: uppercase; letter-spacing: 2px; display: block; margin-bottom: 2px;}
        .toast-msg { font-family: var(--font-headline); font-size: 0.9rem; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* Helpers */
        .area-icon-row { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .area-option { width: 60px; opacity: 0.5; transition: 0.3s; display:flex; flex-direction:column; align-items:center; cursor:pointer;}
        .area-option.selected { opacity: 1; transform: translateY(-5px); }
        .area-icon-btn { width: 50px; height: 50px; border-radius: 50%; background: var(--card-bg); color: var(--text-main); display: flex; align-items: center; justify-content: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 8px; border: 1px solid transparent; }
        .area-option.selected .area-icon-btn { border-color: var(--accent-gold); color: var(--accent-gold); }
        .area-label { font-family: var(--font-body); font-size: 0.65rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .routine-card { padding: 20px; background: var(--card-bg); margin-bottom: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; font-family: var(--font-body); box-shadow: 0 5px 10px rgba(0,0,0,0.03); }
        .styled-input, .time-input-styled { width: 100%; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; background: var(--card-bg); color: var(--text-main); font-family: var(--font-body); font-size: 1rem; text-align: center; outline: none; box-sizing: border-box; }
        .time-input-styled { font-weight: 600; font-size: 1.2rem; cursor: pointer; }
        .lang-switch-row { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; }
        .lang-btn { padding: 8px 25px; border-radius: 99px; border: 1px solid rgba(0,0,0,0.1); background: var(--card-bg); cursor: pointer; font-family: var(--font-body); font-weight: 600; color: var(--text-sub); transition: 0.3s; font-size: 0.75rem; letter-spacing: 1px; }
        .lang-btn.active { background: var(--accent-color); color: var(--bg-color); border-color: var(--accent-color); }
        .palette-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; justify-items: center; }
        .color-swatch { width: 35px; height: 35px; border-radius: 50%; cursor: pointer; border: 2px solid #fff; box-shadow: 0 5px 10px rgba(0,0,0,0.1); }

    </style>
</head>
<body>

<div id="intro-overlay" style="display:none;">
    
    <div class="intro-slide active" id="intro-1">
        <svg class="icon icon-xl" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        <div class="intro-quote">"Wer zwei Hasen jagt,<br>f√§ngt keinen."</div>
        <div class="intro-sub">‚Äî SPRICHWORT</div>
    </div>
    
    <div class="intro-slide next" id="intro-2">
        <svg class="icon icon-xl" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        <h1 class="intro-title">Das Chaos</h1>
        <p class="intro-text">Wir versuchen oft, alles gleichzeitig zu tun.<br>Das Ergebnis? Stress. Und Stillstand.</p>
    </div>

    <div class="intro-slide next" id="intro-3">
        <svg class="icon icon-xl" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="2"></circle></svg>
        <h1 class="intro-title">Der Fokus</h1>
        <p class="intro-text">Erfolg ist sequenziell, nicht simultan.<br>Eine Sache nach der anderen.</p>
    </div>

    <div class="intro-slide next" id="intro-4">
        <svg class="icon icon-xl" viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
        <h1 class="intro-title">Der Domino-Effekt</h1>
        <p class="intro-text">Finde die erste Aufgabe, die alle anderen einfacher oder √ºberfl√ºssig macht.</p>
    </div>

    <div class="intro-slide next" id="intro-5">
        <svg class="icon icon-xl" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
        <h1 class="intro-title">Dein Commitment</h1>
        <p class="intro-text" style="opacity: 0.7;">Swipe nach oben zum Starten</p>
    </div>

    <div id="global-swipe-hint" class="visible">
        <svg class="icon swipe-arrow" viewBox="0 0 24 24"><path d="M7 11l5-5 5 5"></path><path d="M7 17l5-5 5 5"></path></svg>
        <span class="swipe-text">Swipe</span>
    </div>

    <div class="intro-dots">
        <div class="dot active" id="dot-1"></div><div class="dot" id="dot-2"></div><div class="dot" id="dot-3"></div><div class="dot" id="dot-4"></div><div class="dot" id="dot-5"></div>
    </div>
</div>

<div id="notification-container"></div>

<div class="floating-menu">
    <button class="float-btn" onclick="openOverlay('routineOverlay')"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></button>
    <button class="float-btn" onclick="openOverlay('historyOverlay')"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg></button>
    <button class="float-btn" onclick="openOverlay('settingsOverlay')"><svg class="icon" viewBox="0 0 24 24"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg></button>
</div>

<main class="reel-container" id="mainContainer"></main>

<div id="routineOverlay" class="overlay">
    <button class="close-btn" onclick="closeOverlay('routineOverlay')">√ó</button>
    <div class="overlay-header" data-i18n="new_routine">Neue Routine</div>
    <div class="overlay-card">
        <span style="display:block; font-family:var(--font-body); font-size:0.75rem; margin-bottom:15px; opacity:0.6; text-align: center; text-transform: uppercase; letter-spacing: 1px;" data-i18n="select_area">Bereich W√§hlen</span>
        <div class="area-icon-row" id="routineAreaSelector"></div>
        <input type="hidden" id="rout-area" value="business">
        <input type="text" id="rout-input" class="styled-input">
        <span style="display:block; font-family:var(--font-body); font-size:0.75rem; margin-bottom:5px; opacity:0.6; text-align: center; text-transform: uppercase; letter-spacing: 1px;" data-i18n="time">Uhrzeit</span>
        <input type="time" id="rout-time" class="time-input-styled" value="08:00">
        <div style="height: 20px;"></div>
        <button class="action-btn" style="width:100%;" onclick="addRoutine()" data-i18n="add">Hinzuf√ºgen</button>
    </div>
    <div id="routineList" style="padding-bottom: 50px;"></div>
</div>

<div id="settingsOverlay" class="overlay">
    <button class="close-btn" onclick="closeOverlay('settingsOverlay')">√ó</button>
    <div class="overlay-header" data-i18n="settings">Einstellungen</div>
    <div class="lang-switch-row">
        <button class="lang-btn" onclick="setLanguage('de')" id="lang-de">DE</button>
        <button class="lang-btn" onclick="setLanguage('en')" id="lang-en">EN</button>
        <button class="lang-btn" onclick="setLanguage('es')" id="lang-es">ES</button>
    </div>
    <div class="overlay-card">
        <span style="display:block;margin-bottom:20px; font-weight:600;" data-i18n="bg_color">Design</span>
        <div class="theme-grid">
            <div class="theme-btn" onclick="applyTheme('noble')" id="theme-noble"><div class="theme-preview" style="background:#fdfbf7;"></div>Noble</div>
            <div class="theme-btn" onclick="applyTheme('minimal')" id="theme-minimal"><div class="theme-preview" style="background:#ffffff;"></div>Minimal</div>
            <div class="theme-btn" onclick="applyTheme('midnight')" id="theme-midnight"><div class="theme-preview" style="background:#121212;"></div>Midnight</div>
            <div class="theme-btn" onclick="applyTheme('botanic')" id="theme-botanic"><div class="theme-preview" style="background:#e8f3e8;"></div>Botanic</div>
        </div>
    </div>
    <div class="overlay-card">
        <span style="display:block;margin-bottom:15px; font-weight:600;" data-i18n="order">üîÉ Reihenfolge</span>
        <ul id="dragList" class="sortable-list"></ul>
    </div>
</div>

<div id="historyOverlay" class="overlay">
    <button class="close-btn" onclick="closeOverlay('historyOverlay')">√ó</button>
    <div class="overlay-header" data-i18n="successes">Erfolge</div>
    <ul id="historyList" style="list-style:none; padding:0;"></ul>
    <div style="text-align:center; margin-top:30px;">
        <button onclick="clearHistory()" style="background:none; border:none; color:var(--text-sub); font-family:var(--font-body); font-size:0.8rem; cursor:pointer;" data-i18n="clear_history">Verlauf l√∂schen</button>
    </div>
</div>

<script>
    function triggerHaptic(type) {
        if (!navigator.vibrate) return;
        if (type === 'click') navigator.vibrate(10);
        else if (type === 'success') navigator.vibrate([50, 100, 50, 100, 200]);
        else if (type === 'resisting') navigator.vibrate(20);
    }

    const svgIcons = {
        business: `<svg class="icon icon-xl" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>`,
        finance: `<svg class="icon icon-xl" viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>`,
        health: `<svg class="icon icon-xl" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`,
        personal: `<svg class="icon icon-xl" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
        spiritual: `<svg class="icon icon-xl" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`,
        check: `<svg class="icon" viewBox="0 0 24 24" style="color:#27ae60"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
        alert: `<svg class="icon" viewBox="0 0 24 24" style="color:#d32f2f"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`,
        bell: `<svg class="icon" viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>`
    };

    const i18n = {
        de: {
            focus_btn: "Fokus setzen", done_btn: "Erledigt", waiting: "wartet im Hintergrund", settings: "Einstellungen",
            new_routine: "Neue Routine", select_area: "Bereich w√§hlen", time: "Uhrzeit", add: "Hinzuf√ºgen",
            bg_color: "Design", order: "Reihenfolge", successes: "Erfolge",
            clear_history: "Verlauf l√∂schen", alert_input: "Bitte Text und Zeit eingeben.", routine_notify: "EINE Sache f√§llig:",
            routine_placeholder: "z.B. Team-Meeting vorbereiten", toast_routine: "Automatisierte Task erstellt",
            toast_stagnation: "Stagniert seit 3 Wochen", toast_done: "Aufgabe erledigt! Stark.",
            areas: {
                business: { title: "Business & Beruf", label: "Business", placeholder: "z.B. Projektplan finalisieren", question: "Welche ist die <span class='highlight'>EINE Sache</span> f√ºr meinen <b>Beruf</b>, die alle anderen Aufgaben einfacher oder √ºberfl√ºssig macht?" },
                finance: { title: "Finanzen", label: "Finanzen", placeholder: "z.B. Sparrate auf 20% erh√∂hen", question: "Welche ist die <span class='highlight'>EINE Sache</span> f√ºr meine <b>Finanzen</b>, die alle anderen Aufgaben einfacher oder √ºberfl√ºssig macht?" },
                health: { title: "K√∂rper & Gesundheit", label: "K√∂rper", placeholder: "z.B. 30 Minuten Joggen gehen", question: "Welche ist die <span class='highlight'>EINE Sache</span> f√ºr meine <b>Gesundheit</b>, die alle anderen Aufgaben einfacher oder √ºberfl√ºssig macht?" },
                personal: { title: "Privatleben", label: "Privat", placeholder: "z.B. Einen alten Freund anrufen", question: "Welche ist die <span class='highlight'>EINE Sache</span> f√ºr mein <b>Privatleben</b>, die alle anderen Aufgaben einfacher oder √ºberfl√ºssig macht?" },
                spiritual: { title: "Geist & Spirituelles", label: "Geist", placeholder: "z.B. 10 Minuten Meditation", question: "Welche ist die <span class='highlight'>EINE Sache</span> f√ºr meinen <b>inneren Frieden</b>, die alle anderen Aufgaben einfacher oder √ºberfl√ºssig macht?" }
            }
        },
        en: {
            focus_btn: "Set Focus", done_btn: "Done", waiting: "waiting in queue", settings: "Settings",
            new_routine: "New Routine", select_area: "Select Area", time: "Time", add: "Add",
            bg_color: "Design", order: "Sort Order", successes: "Successes",
            clear_history: "Clear History", alert_input: "Please enter text and time.", routine_notify: "ONE Thing due:",
            routine_placeholder: "e.g. Prepare team meeting", toast_routine: "Automated task created",
            toast_stagnation: "Stagnating for 3 weeks", toast_done: "Task completed! Great job.",
            areas: {
                business: { title: "Business & Career", label: "Business", placeholder: "e.g. Finalize project plan", question: "What's the <span class='highlight'>ONE Thing</span> I can do for my <b>career</b> such that by doing it everything else will be easier or unnecessary?" },
                finance: { title: "Finance", label: "Finance", placeholder: "e.g. Increase savings rate", question: "What's the <span class='highlight'>ONE Thing</span> I can do for my <b>finances</b> such that by doing it everything else will be easier or unnecessary?" },
                health: { title: "Physical Health", label: "Health", placeholder: "e.g. Go for a 30 min run", question: "What's the <span class='highlight'>ONE Thing</span> I can do for my <b>physical health</b> such that by doing it everything else will be easier or unnecessary?" },
                personal: { title: "Personal Life", label: "Personal", placeholder: "e.g. Call an old friend", question: "What's the <span class='highlight'>ONE Thing</span> I can do for my <b>personal life</b> such that by doing it everything else will be easier or unnecessary?" },
                spiritual: { title: "Spiritual", label: "Spirit", placeholder: "e.g. 10 minutes meditation", question: "What's the <span class='highlight'>ONE Thing</span> I can do for my <b>spiritual life</b> such that by doing it everything else will be easier or unnecessary?" }
            }
        },
        es: {
            focus_btn: "Enfocar", done_btn: "Hecho", waiting: "en cola", settings: "Ajustes",
            new_routine: "Nueva Rutina", select_area: "Seleccionar √Årea", time: "Hora", add: "A√±adir",
            bg_color: "Dise√±o", order: "Orden", successes: "√âxitos",
            clear_history: "Borrar Historial", alert_input: "Por favor ingrese texto y hora.", routine_notify: "√öNICA cosa a realizar:",
            routine_placeholder: "p.ej. Preparar reuni√≥n", toast_routine: "Tarea automatizada creada",
            toast_stagnation: "Estancado por 3 semanas", toast_done: "¬°Tarea completada! Bien hecho.",
            areas: {
                business: { title: "Negocios y Carrera", label: "Negocio", placeholder: "p.ej. Finalizar plan", question: "¬øCu√°l es la <span class='highlight'>√öNICA cosa</span> que puedo hacer por mi <b>carrera</b> de tal modo que al hacerlo todo lo dem√°s sea m√°s f√°cil o innecesario?" },
                finance: { title: "Finanzas", label: "Finanzas", placeholder: "p.ej. Aumentar ahorro", question: "¬øCu√°l es la <span class='highlight'>√öNICA cosa</span> que puedo hacer por mis <b>finanzas</b> de tal modo que al hacerlo todo lo dem√°s sea m√°s f√°cil o innecesario?" },
                health: { title: "Salud F√≠sica", label: "Salud", placeholder: "p.ej. Correr 30 min", question: "¬øCu√°l es la <span class='highlight'>√öNICA cosa</span> que puedo hacer por mi <b>salud</b> de tal modo que al hacerlo todo lo dem√°s sea m√°s f√°cil o innecesario?" },
                personal: { title: "Vida Personal", label: "Personal", placeholder: "p.ej. Llamar a un amigo", question: "¬øCu√°l es la <span class='highlight'>√öNICA cosa</span> que puedo hacer por mi <b>vida personal</b> de tal modo que al hacerlo todo lo dem√°s sea m√°s f√°cil o innecesario?" },
                spiritual: { title: "Espiritualidad", label: "Esp√≠ritu", placeholder: "p.ej. Meditar 10 min", question: "¬øCu√°l es la <span class='highlight'>√öNICA cosa</span> que puedo hacer por mi <b>vida espiritual</b> de tal modo que al hacerlo todo lo dem√°s sea m√°s f√°cil o innecesario?" }
            }
        }
    };

    const defaultOrder = ['business', 'finance', 'health', 'personal', 'spiritual'];
    const defaultTheme = { id: 'noble' };
    
    const themes = {
        noble: {
            bg: '#fdfbf7', text: '#1a1a1a', sub: '#555555', accent: '#1e272e', gold: '#d4af37',
            fontHead: "'Playfair Display', serif", fontBody: "'Inter', sans-serif",
            texture: "url(\"data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E\")",
            card: '#ffffff', glass: 'rgba(255, 255, 255, 0.85)'
        },
        minimal: {
            bg: '#ffffff', text: '#000000', sub: '#666666', accent: '#000000', gold: '#666666',
            fontHead: "'Inter', sans-serif", fontBody: "'Inter', sans-serif",
            texture: "none", card: '#f9f9f9', glass: '#f9f9f9'
        },
        midnight: {
            bg: '#121212', text: '#e0e0e0', sub: '#a0a0a0', accent: '#e0e0e0', gold: '#bb86fc',
            fontHead: "'Inter', sans-serif", fontBody: "'Inter', sans-serif",
            texture: "none", card: '#1e1e1e', glass: '#1e1e1e'
        },
        botanic: {
            bg: '#e8f3e8', text: '#1b4d3e', sub: '#4a6b5d', accent: '#1b4d3e', gold: '#b78c64',
            fontHead: "'Lora', serif", fontBody: "'Inter', sans-serif",
            texture: "none", card: '#ffffff', glass: 'rgba(255,255,255,0.6)'
        }
    };
    
    let appData = {
        lang: 'de', introSeen: false,
        tasks: { business: "", health: "", personal: "", finance: "", spiritual: "" },
        taskDates: { business: 0, health: 0, personal: 0, finance: 0, spiritual: 0 },
        backlog: { business: [], health: [], personal: [], finance: [], spiritual: [] },
        history: [], routines: [], order: [...defaultOrder], 
        theme: 'noble'
    };

    try {
        const saved = localStorage.getItem('theOneThingData_v22');
        if (saved) {
            const parsed = JSON.parse(saved);
            appData = { ...appData, ...parsed };
            if(!appData.lang) appData.lang = detectLanguage();
        } else {
            appData.lang = detectLanguage();
        }
    } catch (e) {}

    function detectLanguage() {
        const browser = navigator.language || navigator.userLanguage;
        if (browser.startsWith('de')) return 'de';
        if (browser.startsWith('es')) return 'es';
        return 'en';
    }

    // --- SWIPE LOGIC ---
    function checkIntro() {
        if (!appData.introSeen) {
            const overlay = document.getElementById('intro-overlay');
            overlay.style.display = 'flex';
            
            let startY = 0;
            let currentSlide = 1;
            const maxSlides = 5;
            let lastResistanceVibe = 0;

            overlay.addEventListener('touchstart', e => {
                startY = e.touches[0].clientY;
                // Remove Snap-Back class
                document.querySelectorAll('.intro-slide').forEach(s => s.classList.remove('snap-back'));
            }, {passive: false});

            overlay.addEventListener('touchmove', e => {
                e.preventDefault(); 
                const currentY = e.touches[0].clientY;
                const deltaY = startY - currentY; // Positiv = Swipe Up

                // Logic for Slides 1-4 (Normal)
                if (currentSlide < maxSlides) {
                    return; 
                }

                // Logic for Slide 5 (HEAVY RESISTANCE)
                if (currentSlide === 5 && deltaY > 0) {
                    const slide = document.getElementById(`intro-5`);
                    // Resistance Factor: 0.3 means dragging 100px moves it 30px
                    const resistance = 0.3; 
                    const move = deltaY * resistance;
                    
                    slide.style.transform = `translateY(-${move}px)`;

                    // Progressive Vibration
                    // limit duration
                    const intensity = Math.min(Math.max(5, move / 2), 50);
                    
                    // Trigger vibration every ~25px visual movement
                    if (move > 30 && Math.floor(move / 25) > lastResistanceVibe) {
                        if (navigator.vibrate) navigator.vibrate(intensity);
                        lastResistanceVibe = Math.floor(move / 25);
                    }
                }
            }, {passive: false});

            overlay.addEventListener('touchend', e => {
                const endY = e.changedTouches[0].clientY;
                const distance = startY - endY;

                // Slides 1-4
                if (currentSlide < maxSlides) {
                    if (distance > 50) { 
                        currentSlide++;
                        nextSlide(currentSlide);
                    } else if (distance < -50 && currentSlide > 1) {
                        // Optional: Swipe back? 
                        // Simplified for now: only forward
                    }
                } 
                // Slide 5: Heavy Threshold
                else if (currentSlide === 5) {
                    const slide = document.getElementById(`intro-5`);
                    // Needs visually ~150px (finger ~450px)
                    if (distance * 0.3 > 150) {
                        // Success!
                        slide.style.transition = "transform 0.4s ease-out, opacity 0.4s";
                        slide.style.transform = `translateY(-100vh)`;
                        slide.style.opacity = 0;
                        triggerHaptic('success');
                        finishIntro();
                    } else {
                        // Snap Back
                        slide.classList.add('snap-back');
                        slide.style.transform = `translateY(0px)`;
                        lastResistanceVibe = 0;
                    }
                }
            }, {passive: false});
        }
    }
    
    function nextSlide(n) {
        triggerHaptic('click');
        document.querySelectorAll('.intro-slide').forEach(s => {
            s.classList.remove('active', 'prev', 'next'); s.classList.add('next'); s.style.opacity = ""; s.style.transform = ""; 
        });
        document.querySelectorAll('.dot').forEach(d => d.classList.remove('active'));
        const current = document.getElementById(`intro-${n}`);
        const prevSlide = document.getElementById(`intro-${n-1}`);
        if(prevSlide) { prevSlide.classList.remove('next'); prevSlide.classList.add('prev'); }
        if(current) { 
            current.classList.remove('next'); current.classList.add('active'); 
            if(n === 5) current.classList.add('resisting'); // Add class for resistance handling
        }
        const dot = document.getElementById(`dot-${n}`);
        if(dot) dot.classList.add('active');
        const hint = document.getElementById('global-swipe-hint');
        if(n === 5) { 
            hint.querySelector('.swipe-text').innerText = "Zieh hoch";
        }
    }

    function finishIntro() {
        const overlay = document.getElementById('intro-overlay');
        setTimeout(() => { overlay.style.opacity = '0'; setTimeout(() => { overlay.style.display = 'none'; }, 800); }, 300);
        appData.introSeen = true; saveData();
        if(Notification.permission !== "granted") Notification.requestPermission();
    }

    function showToast(title, message, type = 'normal', systemNotify = false) {
        const container = document.getElementById('notification-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        let iconHtml = svgIcons.bell;
        if(type === 'warning') iconHtml = svgIcons.alert;
        if(type === 'success') iconHtml = svgIcons.check;
        toast.innerHTML = `<div class="toast-icon">${iconHtml}</div><div class="toast-content"><span class="toast-title">${title}</span><span class="toast-msg">${message}</span></div>`;
        container.appendChild(toast);
        setTimeout(() => { toast.style.animation = "fadeOut 0.5s forwards"; setTimeout(() => toast.remove(), 550); }, 4000);
        if (systemNotify && Notification.permission === "granted") new Notification(title, { body: message });
    }

    function checkStagnation() {
        const now = Date.now();
        const threeWeeks = 1000 * 60 * 60 * 24 * 21; 
        Object.keys(appData.tasks).forEach(area => {
            if(appData.tasks[area] && appData.tasks[area] !== "") {
                const created = appData.taskDates[area];
                if(created && (now - created > threeWeeks)) showToast(i18n[appData.lang].toast_stagnation, `"${appData.tasks[area]}"`, 'warning', true);
            }
        });
    }

    function initApp() {
        applyTheme(appData.theme || 'noble');
        updateLanguageUI(); renderSlides(); renderDragList(); renderRoutineAreaSelector();
        appData.order.forEach(a => updateSlideUI(a));
        checkStagnation(); checkIntro();
    }

    function applyTheme(themeName) {
        const t = themes[themeName]; if(!t) return;
        appData.theme = themeName; saveData();
        const r = document.documentElement.style;
        r.setProperty('--bg-color', t.bg); r.setProperty('--text-main', t.text); r.setProperty('--text-sub', t.sub);
        r.setProperty('--accent-color', t.accent); r.setProperty('--accent-gold', t.gold);
        r.setProperty('--font-headline', t.fontHead); r.setProperty('--font-body', t.fontBody);
        r.setProperty('--bg-image', t.texture); r.setProperty('--card-bg', t.card); r.setProperty('--glass-bg', t.glass);
        document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById('theme-'+themeName); if(btn) btn.classList.add('active');
    }

    function setLanguage(lang) {
        appData.lang = lang; saveData(); updateLanguageUI();
        renderSlides(); renderDragList(); renderRoutineAreaSelector(); renderRoutinen(); renderHistory();
        appData.order.forEach(a => updateSlideUI(a));
    }

    function updateLanguageUI() {
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('lang-'+appData.lang).classList.add('active');
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if(i18n[appData.lang][key]) el.innerText = i18n[appData.lang][key];
        });
        document.getElementById('rout-input').placeholder = i18n[appData.lang].routine_placeholder;
    }

    function renderSlides() {
        const container = document.getElementById('mainContainer'); container.innerHTML = "";
        const t = i18n[appData.lang];
        appData.order.forEach(area => {
            const config = t.areas[area];
            const section = document.createElement('section');
            section.className = "life-slide"; section.id = `slide-${area}`;
            section.innerHTML = `
                <h1 class="area-title">${config.title}</h1>
                <div class="content-wrapper">
                    <div class="input-mode" id="input-${area}">
                        <p class="question">${config.question}</p>
                        <input type="text" class="main-input" id="in-${area}" placeholder="${config.placeholder}">
                        <button class="action-btn" onclick="setOneThing('${area}')">${t.focus_btn}</button>
                    </div>
                    <div class="active-task-display" id="display-${area}">
                        <span class="focus-label">FOKUS ‚Ä¢ ${config.title.toUpperCase()}</span>
                        <div class="big-task" id="text-${area}"></div>
                        <div class="queue-badge" id="queue-${area}" style="display:none;">+<span id="count-${area}">0</span> ${t.waiting}</div>
                        <br><button class="action-btn" onclick="completeTask('${area}')">${t.done_btn}</button>
                    </div>
                </div>`;
            container.appendChild(section);
        });
    }

    function renderRoutineAreaSelector() {
        const container = document.getElementById('routineAreaSelector'); container.innerHTML = "";
        const areas = ['business', 'finance', 'health', 'personal', 'spiritual'];
        const icons = { business: svgIcons.business, finance: svgIcons.finance, health: svgIcons.health, personal: svgIcons.personal, spiritual: svgIcons.spiritual };
        areas.forEach(area => {
            const label = i18n[appData.lang].areas[area].label;
            const isSelected = document.getElementById('rout-area').value === area ? 'selected' : '';
            container.innerHTML += `<div class="area-option ${isSelected}" onclick="selectRoutineArea(this, '${area}')"><div class="area-icon-btn">${icons[area]}</div><span class="area-label">${label}</span></div>`;
        });
    }

    function setOneThing(area, textOverride = null) {
        triggerHaptic('click');
        const input = document.getElementById(`in-${area}`); const text = textOverride || input.value;
        if(!text) return;
        if (appData.tasks[area] && appData.tasks[area] !== "") { appData.backlog[area].push(appData.tasks[area]); }
        appData.tasks[area] = text; appData.taskDates[area] = Date.now();
        if(input) input.value = "";
        saveData(); updateSlideUI(area);
    }

    function completeTask(area) {
        triggerHaptic('success');
        const currentTask = appData.tasks[area];
        if (currentTask) {
            appData.history.unshift({ task: currentTask, area: area, date: new Date().toLocaleDateString(appData.lang) });
            showToast(i18n[appData.lang].toast_done, currentTask, 'success', false); 
            if (appData.backlog[area].length > 0) {
                const nextTask = appData.backlog[area].shift();
                appData.tasks[area] = nextTask; appData.taskDates[area] = Date.now();
            } else { appData.tasks[area] = ""; }
            saveData(); updateSlideUI(area);
        }
    }

    function updateSlideUI(area) {
        const hasTask = appData.tasks[area] && appData.tasks[area] !== "";
        const inp = document.getElementById(`input-${area}`); const disp = document.getElementById(`display-${area}`);
        if(inp) inp.style.display = hasTask ? 'none' : 'flex';
        if(disp) disp.style.display = hasTask ? 'block' : 'none';
        if (hasTask) {
            document.getElementById(`text-${area}`).innerText = appData.tasks[area];
            const queueCount = appData.backlog[area].length;
            const badge = document.getElementById(`queue-${area}`);
            if (queueCount > 0) { badge.style.display = "inline-block"; document.getElementById(`count-${area}`).innerText = queueCount; } 
            else { badge.style.display = "none"; }
        }
    }

    function addRoutine() {
        const text = document.getElementById('rout-input').value;
        const area = document.getElementById('rout-area').value;
        const time = document.getElementById('rout-time').value;
        if (!text || !time) return alert(i18n[appData.lang].alert_input);
        appData.routines.push({ id: Date.now(), text, area, time, lastTriggered: "" });
        saveData(); renderRoutinen();
        document.getElementById('rout-input').value = "";
        triggerHaptic('click');
    }
    
    function renderRoutinen() {
        const list = document.getElementById('routineList'); list.innerHTML = "";
        appData.routines.sort((a,b)=>a.time.localeCompare(b.time)).forEach(r => {
            const areaLabel = i18n[appData.lang].areas[r.area].title;
            list.innerHTML += `<div class="routine-card"><div style="font-weight:700; color:var(--accent-gold); margin-right:15px; font-size:1.1rem;">${r.time}</div><div style="flex-grow:1;"><small style="opacity:0.6; text-transform:uppercase; letter-spacing:1px; font-size:0.65rem;">${areaLabel}</small><br>${r.text}</div><button onclick="deleteRoutine(${r.id})" style="border:none;background:none;color:var(--text-sub);font-size:1.2rem; cursor:pointer;">√ó</button></div>`;
        });
    }
    function deleteRoutine(id) { appData.routines = appData.routines.filter(r => r.id !== id); saveData(); renderRoutinen(); }

    setInterval(() => {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        const dateStr = now.toDateString();
        appData.routines.forEach(r => {
            if (r.time === timeStr && r.lastTriggered !== dateStr) {
                setOneThing(r.area, r.text); r.lastTriggered = dateStr; saveData();
                document.getElementById(`slide-${r.area}`).scrollIntoView({ behavior: 'smooth' });
                showToast(i18n[appData.lang].routine_notify, r.text, 'normal', true);
            }
        });
    }, 1000);

    function selectRoutineArea(div, area) {
        document.querySelectorAll('.area-option').forEach(b => b.classList.remove('selected'));
        div.classList.add('selected'); document.getElementById('rout-area').value = area;
    }
    function saveData() { localStorage.setItem('theOneThingData_v22', JSON.stringify(appData)); }
    function openOverlay(id) { document.getElementById(id).classList.add('active'); if(id==='historyOverlay')renderHistory(); if(id==='routineOverlay')renderRoutinen(); }
    function closeOverlay(id) { document.getElementById(id).classList.remove('active'); }
    
    function renderDragList() {
        const list = document.getElementById('dragList'); list.innerHTML = "";
        appData.order.forEach((area, i) => {
            const li = document.createElement('li');
            li.className = 'sortable-item'; li.setAttribute('data-idx', i);
            li.innerHTML = `${i18n[appData.lang].areas[area].title} <span>‚â°</span>`;
            li.draggable = true;
            li.ondragstart = e => { li.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; };
            li.ondragend = e => { li.classList.remove('dragging'); updateOrderFromDOM(); };
            li.addEventListener('touchstart', e => { li.classList.add('dragging'); triggerHaptic('hold'); }, {passive:true});
            li.addEventListener('touchmove', e => {
                e.preventDefault(); const touch = e.touches[0];
                const target = document.elementFromPoint(touch.clientX, touch.clientY);
                const sortItem = target?.closest('.sortable-item');
                if(sortItem && sortItem !== li) {
                    const box = sortItem.getBoundingClientRect();
                    const next = (touch.clientY - box.top) / (box.bottom - box.top) > 0.5;
                    list.insertBefore(li, next && sortItem.nextSibling || sortItem);
                }
            }, {passive:false});
            li.addEventListener('touchend', e => { li.classList.remove('dragging'); updateOrderFromDOM(); });
            list.appendChild(li);
        });
        list.ondragover = e => {
            e.preventDefault(); const dragging = document.querySelector('.dragging');
            const siblings = [...list.querySelectorAll('.sortable-item:not(.dragging)')];
            let nextSibling = siblings.find(sibling => e.clientY <= sibling.getBoundingClientRect().top + sibling.offsetHeight / 2);
            list.insertBefore(dragging, nextSibling);
        };
    }

    function updateOrderFromDOM() {
        const newOrder = [];
        document.querySelectorAll('#dragList .sortable-item').forEach(li => {
            const oldIdx = parseInt(li.getAttribute('data-idx'));
            newOrder.push(appData.order[oldIdx]);
        });
        const newAreaOrder = [];
        const titles = document.querySelectorAll('#dragList .sortable-item');
        titles.forEach(t => {
             const text = t.innerText.replace(' ‚â°','');
             const areaKey = Object.keys(i18n[appData.lang].areas).find(k => i18n[appData.lang].areas[k].title === text);
             if(areaKey) newAreaOrder.push(areaKey);
        });
        if(newAreaOrder.length === 5) {
            appData.order = newAreaOrder; saveData(); renderSlides(); renderDragList();
            appData.order.forEach(a => updateSlideUI(a));
        }
    }

    function renderHistory() {
        const l = document.getElementById('historyList'); l.innerHTML = "";
        appData.history.forEach(h => l.innerHTML += `<li style="padding:15px; border-bottom:1px solid rgba(0,0,0,0.05); font-family:var(--font-headline);"><small style="font-family:var(--font-body); opacity:0.6; text-transform:uppercase; font-size:0.65rem;">${h.date} ‚Ä¢ ${i18n[appData.lang].areas[h.area].title}</small><br>${h.task}</li>`);
    }
    function clearHistory() { appData.history=[]; saveData(); renderHistory(); }
    initApp();
</script>
</body>
</html>